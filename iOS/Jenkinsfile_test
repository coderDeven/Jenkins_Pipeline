pipeline {
    agent { label 'deven' }
    environment {
        AD_Type = 0
        Firebase_Switch = "false"
        Unity_Path = ""
    }
    stages {
        stage('export_path') {
            steps {
                sh 'python3 iOS/Environment/SetupEnv.py'
            }
        }
        // 用于将 Jenkins 参数进行转换. 对于 Jenkins job 的设置要简单不易出错，通过脚本进行相应转换后再使用.
        stage('parse_param') {
            steps {
                script {
                    AD_Type = sh "python3 iOS/Params/ParamParse.py -adoption ${ad_option}"
                    echo "AD_Type : ${AD_Type}"
                    Firebase_Switch = sh "python3 iOS/Params/ParamParse.py -firebase ${firebase_enable}"
                }
            }
        }
        // 校验 Jenkins 参数与 DDcommon 中参数是否一致.
        stage('check_param') {
            steps {
                sh "python3 iOS/Params/ParamCheck.py ./ddCommon.json ${game_id} ${push_enable} ${firebase_enable}"
            }
        }
        stage('fetch_apple_cert_info') {
            steps {
                echo "获取证书信息 :"
                sh "python3 iOS/AppleCert/AppleCertManager.py ${NODE_AGENT_LABEL} ${game_id} ${push_enable}"
            }
        }

        stage('setup_pod_env') {
            steps {
                echo "设置 pod 环境，待测试"
                sh 'iOS/Pod/SetupPodEnv.sh'
            }
        }

        stage('setup_unity') {
            steps {
                script {
                    // echo "设置 Unity 参数"
                    // sh "python3 iOS/Unity/UnityUtil.py -colorspace ${linear_color_space}"
                    echo "确定 Unity 路径"

                    // Unity_Path = sh "python3 iOS/Unity/UnityUtil.py -getpath ${NODE_AGENT_LABEL} ${unity_version}"
                    // Unity_Path=$(sh "python3 iOS/Unity/UnityUtil.py -getpath ${NODE_AGENT_LABEL} ${unity_version}")
                    // Unity_Path = sh "python3 iOS/Unity/UnityUtil.py -getpath deven unity_2019"
                    // echo "Unity_Path : ${Unity_Path}"

                    // sh 'iOS/Unity/UnitySetup.sh'
                    Unity_Path = "我是一个路径 .Please"
                    // 下边这一行出错
                    echo "Unity_Path : ${Unity_Path}"
                }
            }
        }

        stage('xcodebuild') {
            steps {
                echo "Unity_Path : ${Unity_Path}"
                echo "steps 中 必须有 command, 不能为空"
                // sh "./iOS/Sdebug.sh"
            }
        }
    }

    post {
        always {
            echo "always execution after stages"
        }
        success {
            echo "pipeline execution success"
        }

        failure {
            echo "pipeline execution failed"
        }

    }
}